(function(e){e.JRepeatable=function(t,n,r){var r=null,i=null,s=null,o,n,u,a=e(t+"_button"),f=false,l=null,c=e("<div>");c.css({"background-color":"#000",opacity:.4,"z-index":9998,position:"fixed",left:0,top:0,height:"100%",width:"100%"}).hide();c.appendTo("body");openWindow=function(){if(!i){makeWin();s.prependTo(i)}s.show();i.show();resizeWin();c.show();u=getTrs().clone()};makeWin=function(){if(i){return}i=e("<div/>");i.css({padding:"5px","background-color":"#fff",display:"none","z-index":9999,position:"fixed",left:"50%",top:"50%"});i.appendTo("body");var t=e('<button class="btn button btn-primary"/>').text(Joomla.JText._("JAPPLY"));t.on("click",function(e){e.stopPropagation();store();l.find("table").replaceWith(s);close()});var n=e('<button class="btn button btn-link"/>').text(Joomla.JText._("JCANCEL"));n.on("click",function(t){f=true;t.stopPropagation();e(s).find("tbody tr").replaceWith(u);l.find("table").replaceWith(s);close();i=null});var r=e('<div class="controls form-actions"/>').css({"text-align":"right","margin-bottom":0}).append([n,t]);i.append(s);i.append(r);if(!f){build()}watchButtons()};resizeWin=function(){var e=-1*(i.width()/2);var t=-1*(i.height()/2);i.css({"margin-left":e,"margin-top":t})};close=function(){s.hide();i.hide();c.hide()};getRadioValues=function(){var t=[];e.each(getTrs(),function(n,r){var i=e(r).find('input[type="radio"]:checked');var s=i.length>0?i.val():s="";t.push(s)});return t};setRadioValues=function(t){e.each(getTrs(),function(n,r){var i=e(r).find('input[type="radio"][value="'+t[n]+'"]');if(i.length>0){i.attr("checked","checked")}})};watchButtons=function(){i.on("click","a.add",function(t){if(tr=findTr(t)){var n=getRadioValues();var r=e(tr).closest("table").find("tbody");var i=o.clone(true,true);i.appendTo(r);renameInputs();setRadioValues(n);resizeWin();resetChosen(i)}return false}.bind(this));i.on("click","a.remove",function(e){if(tr=findTr(e)){tr.remove()}resizeWin();return false}.bind(this))};resetChosen=function(t){t.find("select").removeClass("chzn-done").show();e.each(t.find("select"),function(e,t){t.id=t.id+"_"+(Math.random()*1e7).toInt()});t.find(".chzn-container").remove();e("select").chosen({disable_search_threshold:10,allow_single_deselect:true})};getTrs=function(){return i.find("tbody tr")};renameInputs=function(){var t,n,r,i,s,o=getTrs();regex=/\[\]/;for(i=0;i<o.length;i++){s=e(o[i]).find('input[type="radio"], input[type="checkbox"]');e.each(s,function(s,o){if(o.name.match(regex)===null){o.name+="["+i+"]"}else{o.name=o.name.replace(regex,"["+i+"]");o.name+="[]"}r=o.name.split("][");r=r[r.length-3];t=o.id.split("_");t[t.length-1]=r+s;t.push(i);o.id=t.join("_");n=e(this).next("label");n.attr("for",o.id)})}};build=function(){var t,n,s,u,a,f,l,c;n=JSON.decode(e(r).val());if(typeOf(n)==="null"){n={}}s=i.find("tbody tr");u=Object.keys(n);a=u.length===0||n[u[0]].length===0?true:false;f=a?1:n[u[0]].length;for(var h=1;h<f;h++){t=s.clone();t.insertAfter(s);resetChosen(t)}renameInputs();l=getTrs();for(h=0;h<f;h++){e.each(u,function(t,r){console.log(e(l[h]).find('*[name*="'+this+'"]'));e(l[h]).find('*[name*="'+this+'"]').each(function(t,i){c=e(i).attr("type");if(c==="radio"||c==="checkbox"){if(i.value===n[r][h]){e(i).attr("checked","checked")}}else{e(i).val(n[r][h]);if(e(i).prop("tagName")==="SELECT"){e(i).trigger("liszt:updated")}}})})}o=s;if(a){s.remove()}};findTr=function(e){var t=e.target.getParents().filter(function(e){return e.get("tag")==="tr"});return t.length===0?false:t[0]};store=function(){var t,i,o,u,a={};for(t=0;t<n.length;t++){i=n[t];o=s.find('*[name*="'+i+'"]');a[i]=[];e.each(o,function(){u=e(this).attr("type");if(u==="radio"||u==="checkbox"){if(e(this).attr("checked")==="checked"){a[i].push(e(this).val())}}else{a[i].push(e(this).val())}})}r.val(JSON.encode(a));return true};e(document).on("click",'*[data-modal="'+t+'"]',function(t,n){r=e(this).next("input");l=e(this).closest("div.control-group");if(!s){s=l.find("table")}openWindow();return false})}})(jQuery)